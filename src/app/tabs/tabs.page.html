<ion-menu side="start" menuId="main-menu" contentId="main-content">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>Menú</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <ion-item button (click)="navigate('/tabs/devices')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/devices']">
        <ion-icon slot="start" name="server-outline"></ion-icon>
        <ion-label>Dispositivos</ion-label>
      </ion-item>

      <ion-item button (click)="navigate('/tabs/alerts')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/alerts']">
        <ion-icon slot="start" name="warning-outline"></ion-icon>
        <ion-label>Alarmas</ion-label>
      </ion-item>

      <ion-item button (click)="navigate('/tabs/health')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/health']">
        <ion-icon slot="start" name="pulse-outline"></ion-icon>
        <ion-label>Resumen de Salud</ion-label>
      </ion-item>

      <ion-item button (click)="navigate('/tabs/interfaces')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/interfaces']">
        <ion-icon slot="start" name="git-network-outline"></ion-icon>
        <ion-label>Interfaces</ion-label>
      </ion-item>

      <ion-item button (click)="navigate('/tabs/reports')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/reports']">
        <ion-icon slot="start" name="bar-chart-outline"></ion-icon>
        <ion-label>Reportes</ion-label>
      </ion-item>

      <ion-item button (click)="navigate('/tabs/sre-audit')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/sre-audit']">
        <ion-icon slot="start" name="construct-outline"></ion-icon>
        <ion-label>SRE Audit</ion-label>
      </ion-item>

      <ion-item-divider></ion-item-divider>

      <ion-item button (click)="navigate('/tabs/settings')" routerLinkActive="active-menu-item"
        [routerLink]="['/tabs/settings']">
        <ion-icon slot="start" name="settings-outline"></ion-icon>
        <ion-label>Configuración</ion-label>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>
      OpManager MSP Dashboard
    </ion-title>

    <!-- Filtro de Cliente - Slot separado para mejor control -->
    <div slot="end" class="header-controls">
      <ion-select class="client-filter-select" [value]="selectedCustomer$ | async"
        (ionChange)="onCustomerFilterChange($event)" interface="popover" placeholder="Cliente">
        <ion-select-option value="-1">Todos</ion-select-option>
        <ion-select-option *ngFor="let customer of customers$ | async" [value]="customer.CustomerID">
          {{ customer.CustomerName }}
        </ion-select-option>
      </ion-select>
    </div>

    <ion-buttons slot="end">
      <!-- Botón Limpiar Filtros -->
      <ion-button (click)="clearAllFilters()" fill="clear" title="Limpiar todos los filtros" class="clean-btn">
        <img src="assets/clean_icon.png" alt="Limpiar" class="clean-icon" />
      </ion-button>

      <ion-button (click)="toggleTheme()" fill="clear">
        <ion-icon [name]="isDarkMode ? 'sunny-outline' : 'moon-outline'"></ion-icon>
      </ion-button>

      <ion-button (click)="onRefresh()" fill="clear">
        <ion-icon name="refresh"></ion-icon>
        <ion-label class="ion-padding-start ion-hide-sm-down">Actualizar</ion-label>
      </ion-button>

      <ion-button routerLink="/tabs/settings" fill="clear">
        <ion-icon name="settings-outline"></ion-icon>
      </ion-button>

      <ion-chip *ngIf="connectionStatus$ | async as status" [color]="status.color" class="status-chip">
        <ion-icon name="ellipse" color="light"></ion-icon>
        <ion-label>{{ status.text }}</ion-label>
      </ion-chip>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- Stats Row - Siempre visible - Ahora colapsable -->
<div class="stats-container" [class.collapsed]="!showStats">
  <div class="stats-row">
    <ion-grid *ngIf="stats$ | async as stats">
      <ion-row>
        <ion-col size="12" size-md="3">
          <ion-card class="stat-card blue">
            <ion-card-content>
              <div class="stat-value">{{ stats.totalDevices }}</div>
              <div class="stat-label">Total Dispositivos</div>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="3">
          <ion-card class="stat-card orange">
            <ion-card-content>
              <div class="stat-value">{{ stats.activeAlerts }}</div>
              <div class="stat-label">Alarmas Activas</div>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="3">
          <ion-card class="stat-card green">
            <ion-card-content>
              <div class="stat-value">{{ stats.healthyDevices }}</div>
              <div class="stat-label">Dispositivos Saludables</div>
            </ion-card-content>
          </ion-card>
        </ion-col>
        <ion-col size="12" size-md="3">
          <ion-card class="stat-card red">
            <ion-card-content>
              <div class="stat-value">{{ stats.criticalDevices }}</div>
              <div class="stat-label">Dispositivos Críticos</div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
</div>

<div class="stats-toggler-container">
  <div class="stats-toggler" (click)="toggleStats()">
    <ion-icon [name]="showStats ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
  </div>
</div>

<!-- Spinner de Carga Global -->
<div class="global-loading-overlay" *ngIf="loading$ | async">
  <div class="loading-content">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando datos...</p>
  </div>
</div>

<ion-content id="main-content">
  <ion-router-outlet></ion-router-outlet>
</ion-content>