<ion-menu side="end" menuId="devices-filters-menu" contentId="devices-content">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>Filtros</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="closeFiltersMenu()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <!-- Filtro Cliente -->
      <ion-item>
        <ion-label position="stacked">Cliente</ion-label>
        <ion-select [value]="selectedCustomer" (ionChange)="onCustomerChange($event)" [disabled]="loading"
          interface="popover" placeholder="Seleccionar cliente">
          <ion-select-option value="all">Todos</ion-select-option>
          <ion-select-option *ngFor="let c of dashboard.customers$ | async" [value]="c.CustomerID">
            {{ c.CustomerName }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Filtro Tipo de Dispositivo -->
      <ion-item>
        <ion-label position="stacked">Tipo de Dispositivo</ion-label>
        <ion-input [value]="typeInputValue" (ionInput)="onTypeInputChange($event)" placeholder="Escribir o pegar..."
          [disabled]="loading">
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-select [value]="selectedType" (ionChange)="onTypeChange($event)" [disabled]="loading" interface="popover"
          placeholder="Seleccionar tipo">
          <ion-select-option value="all">Todos</ion-select-option>
          <ion-select-option value="Switch">Switch</ion-select-option>
          <ion-select-option value="Router">Router</ion-select-option>
          <ion-select-option value="Server">Server</ion-select-option>
          <ion-select-option value="Firewall">Firewall</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Filtro Estado -->
      <ion-item>
        <ion-label position="stacked">Estado</ion-label>
        <ion-input [value]="statusInputValue" (ionInput)="onStatusInputChange($event)" placeholder="Escribir o pegar..."
          [disabled]="loading">
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-select [value]="selectedStatus" (ionChange)="onStatusChange($event)" [disabled]="loading"
          interface="popover" placeholder="Seleccionar estado">
          <ion-select-option value="all">Todos</ion-select-option>
          <ion-select-option value="clear">Clear</ion-select-option>
          <ion-select-option value="critical">Critical</ion-select-option>
          <ion-select-option value="warning">Warning</ion-select-option>
          <ion-select-option value="attention">Attention</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Botón Exportar -->
      <ion-item>
        <ion-button expand="block" color="success" (click)="exportToCsv()">
          <ion-icon name="download" slot="start"></ion-icon>
          Exportar a Excel
        </ion-button>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header>
  <ion-toolbar>
    <ion-title size="large">Dispositivos</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openFiltersMenu()" fill="clear">
        <ion-icon name="funnel-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content id="devices-content" class="ion-padding">
  <div class="page-container">
    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Spinner mientras se cargan los datos -->
      <div *ngIf="loading" class="loading-container">
        <ion-spinner color="primary"></ion-spinner>
        <p>Cargando dispositivos...</p>
      </div>

      <ion-card *ngIf="!loading" class="data-card">
        <ion-card-content>
          <div class="table-responsive">
            <ion-grid class="devices-table">
              <ion-row class="header-row">
                <ion-col size="2">Nombre</ion-col>
                <ion-col size="2">IP</ion-col>
                <ion-col size="2">Estado</ion-col>
                <ion-col size="2">Salud</ion-col>
                <ion-col size="1">Tipo</ion-col>
                <ion-col size="2">Última Actualización</ion-col>
                <ion-col size="1"></ion-col>
              </ion-row>
              <ion-row *ngFor="let d of pagedDevices; let i = index" class="data-row" [class.expanded]="isExpanded(i)">
                <ion-col size="2">
                  <div class="text-cell" [class.truncated]="!isExpanded(i)"
                    [title]="d.displayName || d.deviceName || d.name">
                    {{ d.displayName || d.deviceName || d.name }}
                  </div>
                </ion-col>
                <ion-col size="2">
                  <div class="text-cell" [class.truncated]="!isExpanded(i)">
                    {{ d.ipaddress || d.ip }}
                  </div>
                </ion-col>
                <ion-col size="2">
                  <ion-badge [color]="getStatusColor(d.statusStr || '')">{{ d.statusStr || 'N/A' }}</ion-badge>
                </ion-col>
                <ion-col size="2">
                  <div class="text-cell" [class.truncated]="!isExpanded(i)">
                    {{ d.statusStr || 'N/A' }}
                  </div>
                </ion-col>
                <ion-col size="1">
                  <div class="text-cell" [class.truncated]="!isExpanded(i)">
                    {{ d.category || d.type }}
                  </div>
                </ion-col>
                <ion-col size="2">
                  <div class="text-cell" [class.truncated]="!isExpanded(i)">
                    {{ d.prettyTime || d.addedTime }}
                  </div>
                </ion-col>
                <ion-col size="1" class="expand-col">
                  <ion-button *ngIf="hasLongContent(d)" fill="clear" size="small" (click)="toggleExpand(i)"
                    class="expand-btn">
                    <ion-icon [name]="isExpanded(i) ? 'chevron-up' : 'chevron-down'"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>
        </ion-card-content>
      </ion-card>

      <div class="pagination-controls" *ngIf="filteredDevices.length">
        <ion-button size="small" fill="outline" (click)="prevDevicePage()" [disabled]="currentPage<=1">
          <ion-icon slot="start" name="chevron-back"></ion-icon>
          Anterior
        </ion-button>
        <ion-chip color="primary">
          <ion-label>Página {{currentPage}} / {{ totalDevicePages }}</ion-label>
        </ion-chip>
        <ion-button size="small" fill="outline" (click)="nextDevicePage()" [disabled]="currentPage>=totalDevicePages">
          Siguiente
          <ion-icon slot="end" name="chevron-forward"></ion-icon>
        </ion-button>
      </div>
    </main>
  </div>
</ion-content>